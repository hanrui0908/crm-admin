<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
    	<meta name="viewport" content="width=device-width, initial-scale=1">
		<title></title>
		<link rel="stylesheet" type="text/css" href="../../css/bootstrap.css">
		<link href="../../css/bootstrap-theme.css" rel="stylesheet">
		<!--<link rel="stylesheet" type="text/css" href="../../css/style.css">-->
		<script src="../../js/jquery.js"></script>
		<script src="../../js/public.js"></script>
		<script src="../../js/bootstrap.js"></script>
		<script src="../../bootstrap-datetimepicker-master/js/bootstrap-datetimepicker.js"></script>
		<script src="../../bootstrap-datetimepicker-master/js/locales/bootstrap-datetimepicker.zh-CN.js"></script>
		<link  href="../../bootstrap-datetimepicker-master/css/bootstrap-datetimepicker.css" rel="stylesheet" media="screen">
		<link rel="stylesheet" href="../../bootstraptable/bootstrap-table.css">
		<script src="../../bootstraptable/bootstrap-table.js"></script>
    	<script src="../../bootstraptable/bootstrap-table-zh-CN.js"></script>
    	<style>
    		.sub_right{
    			margin: 10px 0;
    		}
    		.sub_right table tr th{
    			text-align: center;
    		}
    	</style>
	</head>
	<body>
		<div class="panel panel-default">
		  <div class="panel-heading">
		    <h3 class="panel-title">当前位置：模拟考试管理>模拟考试试卷>新建模拟考试试卷</h3>
		  </div>
		  <div class="panel-body">
		  	<!--内容区域-->
		  	<div class="row">
		  		<div class="col-xs-4 col-lg-offset-3">
	  				<form class="form-horizontal" id="form0" enctype="multipart/form-data" method="post">
					  <div class="form-group">
					    <label class="col-xs-3 control-label" for="">试卷名称</label>
					    <div class="col-xs-9">
					    	<input type="text" class="form-control" id="name" placeholder="">
					    </div>
					  </div>
					  <div class="form-group">
					    <label class="col-xs-3 control-label" for="">科目</label>
					    <div class="col-xs-9">
					    	<select id="subject" class="form-control">
					    		
					    	</select>
					    </div>
					  </div>
					  <div class="form-group">
					    <label class="col-xs-3 control-label" for="">模考模板</label>
					    <div class="col-xs-9">
					    	<select id="template" class="form-control">
					    		<option>请先选择科目</option>
					    	</select>
					    </div>
					  </div>
					  
					  <div class="form-group">
					    <label class="col-xs-3 control-label" for="">上传封面</label>
					    <div class="col-xs-9">
					    	<input type="file" id="pic" name="pic">
					    </div>
					  </div>
					  <!--<input id="item_list" name="item_list" type="text" />-->
					  <!--<div class="form-group">
					    <div class="col-sm-offset-3 col-sm-9">
					      <button type="button" class="btn btn-primary" id="addItem">保存</button>
					      <button type="button" class="btn btn-default" id="revert">返回</button>
					      
					    </div>
					  </div>-->
					</form>
					
		  		</div>
		  		<div class="col-xs-12">
		  			<div class="row">
		  				<div class="col-xs-6">
		  					<p class="bg-info" style="line-height: 40px;">添加模考试题</p>
		  					<form class="form-inline">
							  <div class="input-group col-xs-12">
							      <input type="text" class="form-control" id="search_name" placeholder="请输入关键字">
							      <span class="input-group-btn">
							        <button class="btn btn-default" type="button" data-toggle="collapse" href="#collapseExample" aria-expanded="false" aria-controls="collapseExample">
							        	条件<span class="caret"></span>
							        </button>
							        <button type="button" class="btn btn-primary" id="searchBtn">搜索</button>
							      </span>
							    </div>
							</form>
							<div class="collapse" id="collapseExample" style="margin-top: 10px;">
								<div class="panel panel-default">
								  <div class="panel-heading">搜索条件</div>
								  <div class="panel-body">
								    <form class="form-horizontal" id="form" enctype="multipart/form-data" method="post">
									  <div class="form-group">
									    <label class="col-xs-3 control-label" for="">标签</label>
									    <div class="col-xs-9">
									    	<!--<select id="" class="form-control">
					    		
					    					</select>-->
					    					<input type="text" class="form-control" id="" placeholder="">
									    </div>
									  </div>
									  <div class="form-group">
									    <label class="col-xs-3 control-label" for="">题目难度</label>
									    <div class="col-xs-9">
									    	<!--<select id="" class="form-control">
					    		
					    					</select>-->
					    					<input type="text" class="form-control" id="difficulty" placeholder="">
									    </div>
									  </div>
									  <div class="form-group">
									    <label class="col-xs-3 control-label" for="">星级</label>
									    <div class="col-xs-9">
									    	<input type="text" class="form-control" id="stars" placeholder="">
									    </div>
									  </div>
									  <div class="form-group">
									    <label class="col-xs-3 control-label" for="">年份</label>
									    <div class="col-xs-9">
									    	<input type="text" class="form-control" id="year" placeholder="">
									    	
									    </div>
									  </div>
									  <div class="form-group">
									    <label class="col-xs-3 control-label" for="">题型</label>
									    <div class="col-xs-9">
									    	<select id="item_type" class="form-control">
						                        
						                    </select>
									    </div>
									  </div>
									  <div class="form-group">
									    <label class="col-xs-3 control-label" for="">状态</label>
									    <div class="col-xs-9">
									    	<select id="type" class="form-control">
						                        <option value="0">全部</option>
						                        <option value="1">启用</option>
						                        <option value="2">停用</option>
						                    </select>
									    </div>
									  </div>
									  <div class="form-group">
									    <label class="col-xs-3 control-label" for="">题目来源</label>
									    <div class="col-xs-9">
					    					<input type="text" class="form-control" id="titlefrom" placeholder="">
									    </div>
									  </div>
									  
									</form>
								  </div>
								</div>

							</div>
		  					<div class="subject_main" style="margin-top: 10px;">
		  						<table class="table" id="table"></table>
		  					</div>
		  				</div>
		  				<div class="col-xs-6">
		  					<div class="bg-info" style="line-height: 40px;">
		  						选题区域
		  						<button type="button" class="btn btn-primary" style="float: right; margin-top: 3px;">预览</button>
		  					</div>
		  					<div class="col-xs-12 sub_right">
			  					<h3>选择模考模板后，才可以选题。</h3>
								
							</div>
		  				</div>
		  				<div class="col-xs-12 text-center" style="margin-top: 10px;">
		  					<button type="button" class="btn btn-primary" id="addItem">保存</button>
							<button type="button" class="btn btn-default" id="revert" onclick="location='list.html'">返回</button>
				  		</div>
		  				</div>
		  			</div>
		  		</div>
		  	</div>
		  </div>
		</div>
		<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
		  <div class="modal-dialog modal-lg" role="document">
		    <div class="modal-content">
		      <div class="modal-header">
		        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
		        <h4 class="modal-title" id="myModalLabel">题目详细信息</h4>
		      </div>
		      <div class="modal-body">
				<iframe id="iframe_subject" style="width: 100%; height: 500px;"></iframe>
		      </div>
		      <div class="modal-footer">
		        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
		      </div>
		    </div>
		  </div>
		</div>
	</body>
</html>
<script>
	function subjectList() {
        $('#table').bootstrapTable({
            //请求方法
            method: 'get',
            striped: true,
            cache: false,
            pagination: true,
            sortable: false,
            sortOrder: "asc",
            //pageNumber:1,
            pageSize: 5,
            pageList: [5, 25, 50],
			url: "http://192.168.0.137:8080/yc-crm/item/search",
            queryParams: function(params) {
                var paramObj = {
				    name : $("#search_name").val(),//名称
				    subject : $("#subject").val(),//科目
				    difficulty:$("#difficulty").val(),//难度
				    stars:$("#stars").val(),//星级
				    year:$("#year").val(),//年份
				    item_type:$("#item_type").val(),//题型
				    type:$("#type").val(),//状态
				    titlefrom:$("#titlefrom").val(),//题目来源 
				    plat : '0'
			    };
                params.param = JSON.stringify(paramObj);
                return params;
            },
            sidePagination: "server",
            search: false,
            strictSearch: false,
            idField: "id",
            columns: [{
            	title:'序号',
            	formatter: function(value,row,index){
            		//return index+1;
            		var page = $('#table').bootstrapTable("getPage");
                	return page.pageSize * (page.pageNumber - 1) + index + 1;
            	}
            },{
                field: 'content',
                title: '题干',
                align: 'center',
                formatter:function(value,row,index){
                	var content = decodeURIComponent(row.content);
                	return content;
                }
            },{
                field: 'item_type',
                title: '题型',
                align: 'center',
                formatter: function(value, row, index) {
				    if (value == 1) {
				        return "单选"
				    }
				    if (value == 2) {
				        return "填空"
				    }
				    if (value == 3) {
				        return "解答"
				    }
				    if (value == 4) {
				        return "多选"
				    }
				    if (value == 5) {
				        return "材料"
				    }
				    if (value == 6) {
				        return "完型"
				    }
				    if (value == 7) {
				        return "阅读"
				    }
				    if (value == 8) {
				        return "7选5"
				    }
				    if (value == 9) {
				        return "翻译"
				    }
				    if (value == 10) {
				        return "排序"
				    }
				    if (value == 11) {
				        return "小作文"
				    }
				    if (value == 12) {
				        return "大作文"
				    }
				    if (value == 13) {
				        return "证明"
				    }
				    if (value == 14) {
				        return "其他"
				    }
				}
            },{
                field: 'difficulty',
                title: '难度',
                align: 'center'
            },{
                field: 'title_from',
                title: '来源',
                align: 'center'
            },{
                field: 'stars',
                title: '星级',
                align: 'center'
            },{
                field: 'type',
                title: '状态',
                align: 'center'
            },{
                field: 'id',
                title: '操作',
                align: 'center',
                formatter: function(value, row, index) {
					var html = "<div class='btn-group' role='group'>"+
						"  <a class='btn btn-info btn-xs' onclick='viewSubject(\""+row.id+"\")' role='button'>详细</a>"+
						"  <a class='btn btn-primary btn-xs addPaper' data-id=\""+row.id+"\" data-item_type=\""+row.item_type+"\" role='button'>添加</a>"+
					"</div>";
					return html;
                }
            }],
            pagination: true
        });
    }
	$(function(){
		//科目
        $("#subject").html("<option value='0'>请选择</option>"+get_sub());

		
        $("#subject").change(function(){//选择科目
        	console.log(1)
			var index = $(this).val();
			var json = '[]';
			if(index==3){//英语
				json = '[{"id":"1","text":"单选题","selected":true},{"id":"6","text":"完型"},{"id":"7","text":"阅读题"},{"id":"8","text":"7选5"},{"id":"9","text":"翻译题"},{"id":"10","text":"排序题"},{"id":"11","text":"小作文"},{"id":"12","text":"大作文"}]';
			}else if(index==1){//高数
				json = '[{"id":"1","text":"单选题","selected":true},{"id":"2","text":"填空题"},{"id":"3","text":"解答题"},{"id":"13","text":"证明题"}]';
			}else if(index==2){//政治
				json = '[{"id":"1","text":"单选题","selected":true},{"id":"4","text":"多选题"},{"id":"5","text":"材料题"}]';
			}
			if(index ==0){
				$(".sub_right").html("");
			}
			json = JSON.parse(json)
			opt_html = "<option value=''>全部</option>";
			for(var i = 0;i<json.length;i++){
				opt_html += "<option value="+json[i].id+">"+json[i].text+"</option>";
			}
			$("#item_type").html(opt_html);
			$('#table').bootstrapTable('refresh'); //刷新
			//模板
	        $.ajax({
				type: "post",  
				url: "http://192.168.0.137:8080/yc-crm/imitate/model/search/unpaging/{subject_id:"+index+"}",
				cache:false,
				dataType: "json",
				success: function(msg){
					if(msg.status == 0){
						var html = "<option value=''>请选择</option>";
						var infoList = msg.result.result;
						for(item in infoList){
							html += "<option data-model_element="+infoList[item].model_element+" value="+infoList[item].id+">"+infoList[item].name+"</option>";
						}
						$("#template").html(html);
					}
				}
			});
		});
		$("#template").change(function(){//选择模板
			var model_element = $(this).children("option:selected").data("model_element");
			var righthtml = "";
			for(var el in model_element){
				var item_name = "";
				if(model_element[el].item_type == "1"){
					item_name = "单选题"
				}
			    if (model_element[el].item_type == 2) {
			        item_name = "填空"
			    }
			    if (model_element[el].item_type == 3) {
			        item_name = "解答"
			    }
			    if (model_element[el].item_type == 4) {
			        item_name = "多选"
			    }
			    if (model_element[el].item_type == 5) {
			        item_name = "材料"
			    }
			    if (model_element[el].item_type == 6) {
			        item_name = "完型"
			    }
			    if (model_element[el].item_type == 7) {
			        item_name = "阅读"
			    }
			    if (model_element[el].item_type == 8) {
			        item_name = "7选5"
			    }
			    if (model_element[el].item_type == 9) {
			        item_name = "翻译"
			    }
			    if (model_element[el].item_type == 10) {
			        item_name = "排序"
			    }
			    if (model_element[el].item_type == 11) {
			        item_name = "小作文"
			    }
			    if (model_element[el].item_type == 12) {
			        item_name = "大作文"
			    }
			    if (model_element[el].item_type == 13) {
			        item_name = "证明"
			    }
			    if (model_element[el].item_type == 14) {
			        item_name = "其他"
			    }
				righthtml += "<div class=\"panel panel-info\">"+
				"<div class=\"panel-heading\">"+item_name+"&nbsp;共"+model_element[el].index+"题&nbsp;("+model_element[el].score+"分)</div>"+
				"<div class=\"panel-body\">"+
				"<table class=\"table table-hover table-bordered tab_"+model_element[el].item_type+"\" data-id=\""+model_element[el].imitate_element_id+"\" data-typeId=\""+model_element[el].item_type+"\" data-index=\""+model_element[el].index+"\">"+
				"<tr>"+
				"<th style='display:none;'>序号</th>"+
				"<th>题干</th>"+
				"<th>题型</th>"+
				"<th>难度</th>"+
				"<th>来源</th>"+
				"<th>星级</th>"+
				"<th>状态</th>"+
				"<th class='text-center'>操作</th>"+
				"</tr>"+
//				"<tr>"+
//				"<td>1</td>"+
//				"<td>2</td>"+
//				"<td>1</td>"+
//				"<td>1</td>"+
//				"<td>1</td>"+
//				"<td>2</td>"+
//				"<td>2</td>"+
//				"<td>"+
//				"<div class=\"btn-group\" role=\"group\">"+
//				"<a class=\"btn btn-info btn-xs\" onclick=\"viewSubject()\" role=\"button\">详细</a>"+
//				"<a class=\"btn btn-danger btn-xs\" onclick=\"removePaper()\" role=\"button\">移除</a>"+
//				"</div>"+
//				"</td>"+
//				"</tr>"+
				"</table>"+
				"</div>"+
				"</div>";
			}
			$(".sub_right").html(righthtml)
			
		});
		subjectList();
		$("#searchBtn").click(function(){
			$('#table').bootstrapTable('refresh'); //刷新
		});
		$("#addItem").click(function(){
			var name = $("#name").val();
			var subject = $("#subject").val();
			var template = $("#template").val();
			var pic = $("#pic").val();
			if(!name.trim()){
				alerts("请输入试卷名称");
				return;
			}
			if(subject == 0){
				alerts("请选择科目");
				return;
			}
			if(template == ""){
				alerts("请选择模考模板");
				return;
			}
			if(pic == ""){
				alerts("请上传封面")
				return;
			}
			//组织已选题习题类型和习题
			var arr = []
			var sel_subDom = $(".sub_right").find("table");
			for(var sel = 0;sel<sel_subDom.length;sel++){
				var obj = {
					imitate_element_id : sel_subDom.eq(sel).data("id")
				}
				var subrowList = sel_subDom.eq(sel).find("tr.subRow");
				if(sel_subDom.eq(sel).data("index")!=subrowList.length){
					alerts("模考模板习题没选够数量");
					return;
				}
				var arr0 = [];
				for(var j = 0;j<subrowList.length;j++){
					arr0.push({id:subrowList.eq(j).data("sub_id")});
				}
				obj.subjectList = arr0;
				arr.push(obj);
			}
//			$("#item_list").val(JSON.stringify(arr));
			var objAll = {
				name:name,
				subject:subject,
				model_id:template,
				item_list:arr
			}
			var param = JSON.stringify(objAll);
			var from = new FormData(document.getElementById("form0"));
			from.append("param", param);
			console.log(form)
//			return;
			$.ajax({
		        url: 'http://192.168.0.137:8080/yc-crm/imitate/paper/add',
		        type: 'post',
		        dataType: "json",
		        data: from,
		        contentType: false,
		        processData: false,
		        success: function (msg) {
		        	if(msg.status == 0){
		            	alert("模拟考试试卷添加成功");
		            	location='list.html';
		           	}else{
		           		alerts("模拟考试试卷添加失败");
		           	}
		        }, error: function (msgerr) {
		            console.log(msgerr)
		        }
		    })


		});
		$("body").on("click",".addPaper",function(){
			var subjectId = $(this).data("id");
			var item_type = $(this).data("item_type");
			//获得右侧习题模板题目类型id和题目数量
			var arr = [];
			for(var i=0;i<$(".sub_right").find(".table").length;i++){
				var obj = {
					id:$(".sub_right").find(".table").eq(i).data("id"),//id
					typeid:$(".sub_right").find(".table").eq(i).data("typeid"),//类型id
					index:$(".sub_right").find(".table").eq(i).data("index")//题目数量
				}
				arr.push(obj);
			}
			console.log(arr)
			var flag =false;
			for(o in arr){
				if(arr[o].typeid == item_type){
					flag =true
				}
				
			}
			if(!flag){
				alerts("该模考模板没有该习题题型;");
				return;
			}
			//添加之前判断右侧习题是否已有要添加的习题id
			var right_sub = $(".sub_right").find(".tab_"+item_type+" tbody").find("tr");
			
			for (var i = 0; i < right_sub.length; i++) {
				if(right_sub.eq(i).data("sub_id")==subjectId){
					flag = false;
					break;
				}
			}
			if(!flag){
				alerts("该习题已被添加");
				return;
			}
			flag = $(".sub_right").find(".tab_"+item_type+"").data("index") != parseInt(right_sub.length)-parseInt(1);
			if(!flag){//判断右侧习题是否超出习题数量
				alerts("该题型超出添加的最大习题数量");
				return;
			}
			var this_row = $(this).parents("tr").find("td");
			var td_html ="";
			for(var i = 0;i<this_row.length;i++){
				if(i==0){//序号，暂时隐藏
					td_html += "<td style='display:none'>1</td>";
				}else if(i!=this_row.length-1){
					td_html += "<td class='text-center'>"+this_row.eq(i).html()+"</td>";
				}
				if(i==this_row.length-1){
					td_html += "<td class='text-center'><div class=\"btn-group\" role=\"group\">"+
						"<a class=\"btn btn-info btn-xs\" onclick='viewSubject(\""+subjectId+"\")' role=\"button\">详细</a>"+
						"<a class=\"btn btn-danger btn-xs removePaper\" data-id=\""+subjectId+"\" role=\"button\">删除</a>"+
					"</div></td>";
				}
			}
			td_html = "<tr class='subRow' data-sub_id=\""+subjectId+"\">"+td_html+"</tr>";
			$(".sub_right").find(".tab_"+item_type+" tbody").append(td_html)
			console.log(subjectId+"--"+item_type)
			
		});
		
		//删除右侧已选习题
		$(".sub_right").on("click",".removePaper",function(){
			$(this).parents("tr").remove()
		});
	});
	function viewSubject(subjectId){
		//根据题目id查询该题目信息
		
		//数据绑定到模态对话框
		$("#iframe_subject").attr("src","../subjectAlerts/subject.html?id="+subjectId);
		$('#myModal').modal()
	}
</script>